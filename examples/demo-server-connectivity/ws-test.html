<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    <script>  
        window.addEventListener("load", function(evt) {

            // The bridge layer from our application to the plumbing
            var bridge = {
                // Our websocket
                ws: null,

                // Send an envelope of data to the main application.
                // Replace this default implementation in your app.
                toapp: function(env) {
                    console.log("toapp(env). Replace this with your own implementation");
                },

                // Act on an instruction from the main app: Open, Close, Send
                act: function(data) {
                    switch (data.instruction) {
                        case 'Open':
                            this.open(data.url);
                            return;
                        case 'Close':
                            if (!this.ws) {
                                // Closing non-existent websocket. Odd, but okay
                                return;
                            }
                            this.ws.close();
                            return;
                        case 'Send':
                            if (!this.ws) {
                                this.toapp({error: "Send: Websocket not configured"});
                                return;
                            }
                            this.ws.send(JSON.stringify(data.body));
                            return;
                        default:
                            this.toapp({error: "Unrecognised instruction"});
                            return;
                    }
                },

                // Open a websocket and set up the event handlers
                open: function(url) {
                    parent = this;
                    if (this.ws) {
                        // Already have a websocket connection
                        return false;
                    }
                    this.ws = new WebSocket(url);
                    this.ws.onopen = function(evt) {
                        // No action
                    }
                    this.ws.onclose = function(evt) {
                        parent.toapp({close: true});
                        parent.ws = null;
                    }
                    this.ws.onmessage = function(evt) {
                        // Get the received envelope as structured data
                        env = JSON.parse(evt.data);
                        // If there's a body (base64 encoded) decode it
                        if (env.Body) {
                            env.Body = JSON.parse(atob(env.Body));
                        }
                        parent.toapp(env);
                    }
                    this.ws.onerror = function(evt) {
                        // Error details can't be determined by design. See
                        // https://stackoverflow.com/a/31003057/1830955
                        // The browser will also close the websocket
                        parent.toapp({error: "Websocket error"});
                    }
                },

            };

            // ------------------------------------------------------

            // Elements of our page
            var output = document.getElementById("output");
            var words = document.getElementById("words");
            var truth = document.getElementById("truth");
            var wholenumber = document.getElementById("wholenumber");

            // Functions specific to our simple demo application

            // Add content to the output div, just below the header
            var print = function(message) {
                var d = document.createElement("p");
                d.textContent = message;
                second = output.childNodes.item(1);
                output.insertBefore(d, second);
            };

            // This is what we'll do when the bridge sends data to our app
            bridge.toapp = function(env) {
                print(JSON.stringify(env));
            }

            // Event for our application
            document.getElementById("open").onclick = function(evt) {
                bridge.act({
                    instruction: "Open",
                    url: "ws://localhost:8080/sample-game"
                });
                return false;
            };
            document.getElementById("send").onclick = function(evt) {
                msg = {
                    words: words.value,
                    truth: truth.checked,
                    wholenumber: parseInt(wholenumber.value)

                };
                bridge.act({instruction: "Send", body: msg});
                return false;
            };
            document.getElementById("close").onclick = function(evt) {
                bridge.act({instruction: "Close" });
                return false;
            };
        });
    </script>
    </head>
    <body>
        <table>
            <tr><td valign="top" width="50%">
                <p>Click "Open" to connect to the server.
                "Send" to send a message to the server.
                "Close" to close the connection. 
                You can change the message and send multiple times.
                </p>
                <p>This code assumes the server is at
                http://localhost:8080</p>
                <form>
                    <button id="open">Open</button>
                    <button id="close">Close</button>
                    <p>
                    {<br/>
                    Words:
                    <input id="words" type="text" value="Hello world!"><br/>
                    Truth
                    <input id="truth" type="checkbox" value="true"><br/>
                    Whole number:
                    <input id="wholenumber" type="text" value="27"><br/>
                    }
                    </p>
                    <button id="send">Send</button>
                </form>
            </td><td valign="top" width="50%">
                <div id="output"><p>
                    Application messages appear here, latest first:
                </p></div>
            </td></tr>
        </table>
    </body>
</html>
