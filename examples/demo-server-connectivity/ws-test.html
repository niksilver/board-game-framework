<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    <script>  
        window.addEventListener("load", function(evt) {
            var output = document.getElementById("output");
            var ws;

            // Our inputs 
            var words = document.getElementById("words");
            var truth = document.getElementById("truth");
            var wholenumber = document.getElementById("wholenumber");

            // Add content to the top of the output div
            var printtop = function(message) {
                var d = document.createElement("p");
                d.textContent = message;
                first = output.firstChild;
                output.insertBefore(d, first);
            };

            // Send an envelope of data to the main application.
            // An error will also be logged to the console.
            var toapp = function(env) {
                if (env.Error) {
                    console.log(env.Error);
                }
                printtop("To app: " + JSON.stringify(env));
            }

            // Act on an instruction from the main app: Open, Close, Send
            var act = function(data) {
                switch (data.instruction) {
                    case 'Open':
                        open(data.url);
                        return;
                    case 'Close':
                        if (!ws) {
                            // Closing non-existent websocket. Odd, but okay
                            return;
                        }
                        ws.close();
                        return;
                    case 'Send':
                        if (!ws) {
                            toapp({Error: "Send: Websocket not configured"});
                            return;
                        }
                        ws.send(JSON.stringify(data.body));
                        return;
                    default:
                        toapp({Error: "Unrecognised instruction"});
                        return;
                }
            }

            // Open a websocket and set up the event handlers
            var open = function(url) {
                if (ws) {
                    // Already have a websocket connection
                    return false;
                }
                ws = new WebSocket(url);
                ws.onopen = function(evt) {
                    printtop("OPEN");
                }
                ws.onclose = function(evt) {
                    printtop("CLOSE");
                    toapp({Error: "Connection closed"});
                    ws = null;
                }
                ws.onmessage = function(evt) {
                    // Get the received envelope as structured data
                    env = JSON.parse(evt.data);
                    // If there's a body (base64 encoded) decode it
                    if (env.Body) {
                        env.Body = JSON.parse(atob(env.Body));
                    }
                    printtop("RESPONSE: " + JSON.stringify(env));
                    toapp(env);
                }
                ws.onerror = function(evt) {
                    // Error details can't be determined by design. See
                    // https://stackoverflow.com/a/31003057/1830955
                    // The browser will also close the websocket
                    printtop("ERROR of some kind");
                    toapp({Error: "Websocket error"});
                }
            }

            // Functions for websocket i/o
            document.getElementById("open").onclick = function(evt) {
                act({
                    instruction: "Open",
                    url: "ws://localhost:8080/sample-game"
                });
                return false;
            };
            document.getElementById("send").onclick = function(evt) {
                msg = {
                    words: words.value,
                    truth: truth.checked,
                    wholenumber: parseInt(wholenumber.value)

                };
                printtop("SEND: " + JSON.stringify(msg));
                act({instruction: "Send", body: msg});
                return false;
            };
            document.getElementById("close").onclick = function(evt) {
                act({instruction: "Close" });
                return false;
            };
        });
    </script>
    </head>
    <body>
        <table>
            <tr><td valign="top" width="50%">
                <p>Click "Open" to connect to the server.
                "Send" to send a message to the server.
                "Close" to close the connection. 
                You can change the message and send multiple times.
                </p>
                <p>This code assumes the server is at
                http://localhost:8080</p>
                <form>
                    <button id="open">Open</button>
                    <button id="close">Close</button>
                    <p>
                    {<br/>
                    Words:
                    <input id="words" type="text" value="Hello world!"><br/>
                    Truth
                    <input id="truth" type="checkbox" value="true"><br/>
                    Whole number:
                    <input id="wholenumber" type="text" value="27"><br/>
                    }
                    </p>
                    <button id="send">Send</button>
                </form>
            </td><td valign="top" width="50%">
                <div id="output"></div>
            </td></tr>
        </table>
    </body>
</html>
